name: Build and Push Docker Image
on:
  # 允许通过 GitHub 网页界面手动触发工作流
  workflow_dispatch:
    inputs:
      dockerfile-path:
        description: 'Dockerfile 所在目录的路径 (例如: ./app 或 .)'
        required: true
        default: '.'
      image-tag:
        description: '镜像标签 (例如: latest, v1.0.0)'
        required: true
        default: 'latest'
      target-registry:
        description: '选择要推送到的镜像仓库'
        required: true
        type: choice
        options:
          - dockerhub
          - aliyun
          - both

env:
  # 设置镜像名称，建议使用小写。格式为：用户名/仓库名
  IMAGE_NAME: "your-username/your-repo"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        # 根据选择的条件登录 Docker Hub
        if: inputs.target-registry == 'dockerhub' || inputs.target-registry == 'both'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to Aliyun Container Registry
        # 根据选择的条件登录阿里云镜像仓库
        if: inputs.target-registry == 'aliyun' || inputs.target-registry == 'both'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }} # 例如: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # 构建上下文的路径，通常为 Dockerfile 所在的目录
          context: ${{ github.event.inputs.dockerfile-path }}
          # 指定 Dockerfile 的路径。如果 Dockerfile 在构建上下文根目录下且名为 Dockerfile，则可省略。
          # 如果 Dockerfile 有不同名称或路径，请显式指定，例如：file: ${{ github.event.inputs.dockerfile-path }}/Dockerfile.prod
          file: ${{ github.event.inputs.dockerfile-path }}/Dockerfile
          push: true
          tags: |
            # 为 Docker Hub 生成标签
            ${{ env.IMAGE_NAME }}:${{ github.event.inputs.image-tag }}
            ${{ env.IMAGE_NAME }}:latest
            # 为阿里云生成标签 (格式: registry.cn-地区.aliyuncs.com/命名空间/仓库名:标签)
            ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max